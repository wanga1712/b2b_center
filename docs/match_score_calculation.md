# Расчет score (процента совпадений) в системе поиска

## Общая логика расчета score

### 1. Для основных совпадений (товары из БД)

#### Алгоритм:

**Шаг 1: Поиск ключевых слов**
- Из названия товара извлекаются ключевые слова (слова >= 3 символов)
- Пример: "ДенсТоп ЭП 203 (Комплект_1)" → ["денстоп", "эп", "203"]

**Шаг 2: Проверка совпадений**

1. **100% совпадение (score = 100.0):**
   - Точное совпадение названия товара (без скобок)
   - Точное совпадение полной фразы из ключевых слов

2. **Частичное совпадение:**

   **keywords_ratio = найденные_ключевые_слова / всего_ключевых_слов**

   **Если keywords_ratio >= 0.6 (60%+ ключевых слов найдено):**
   ```
   score = 85.0 + (keywords_ratio - 0.6) * 15.0
   ```
   
   **Диапазон:** 85.0 - 100.0
   
   **Примеры:**
   - 60% ключевых слов → score = 85.0
   - 70% ключевых слов → score = 86.5
   - 80% ключевых слов → score = 88.0
   - 90% ключевых слов → score = 91.5
   - 100% ключевых слов → score = 100.0

   **Если keywords_ratio >= 0.3 и < 0.6 (30-60% ключевых слов):**
   ```
   score = 35.0 + (keywords_ratio - 0.3) * 50.0
   ```
   
   **Диапазон:** 35.0 - 84.99
   
   **Примеры:**
   - 30% ключевых слов → score = 35.0
   - 45% ключевых слов → score = 42.5
   - 60% ключевых слов → score = 85.0

   **Если keywords_ratio < 0.3 (меньше 30%):**
   - Совпадение не засчитывается → score = 0.0 (совпадение отбрасывается)

3. **Поиск с учетом опечаток:**
   - Для каждого ключевого слова сначала ищется точное вхождение
   - Если не найдено → используется fuzzy search (rapidfuzz)
   - Если similarity >= 85% → ключевое слово считается найденным

### 2. Для дополнительных фраз

**Score фиксированный: всегда 85.0**

Дополнительные фразы:
- Ищутся точным совпадением (без fuzzy search)
- Если фраза найдена → score = 85.0
- Фраза используется как название товара

**Список дополнительных фраз:**
- Композитные перильные ограждения (16 вариаций)
- Система внешнего армирования (13 вариаций)
- Композитные водоотводные лотки (22 вариации)
- Инъектирование и гидроизоляция (12 вариаций)
- Наливные полы (8 вариаций)
- Промышленные полы (6 вариаций)
- Усиление конструкций (9 вариаций)

### 3. Определение match_percentage для торга

**Алгоритм:**
```python
exact_count = количество совпадений с score >= 100.0
good_count = количество совпадений с score >= 85.0

if exact_count > 0:
    match_percentage = 100.0  # Есть 100% совпадения
elif good_count > 0:
    match_percentage = 85.0   # Есть 85% совпадения
else:
    match_percentage = 0.0    # Нет значимых совпадений
```

**Важно:**
- Процент определяется по ЛУЧШЕМУ совпадению, не по среднему
- Если есть хотя бы одно совпадение с score >= 100 → 100%
- Если нет 100%, но есть score >= 85 → 85%
- Если все совпадения < 85 → 0%

## Примеры расчета

### Пример 1: Точное совпадение
**Товар:** "ДенсТоп ЭП 203"
**Текст в документе:** "ДенсТоп ЭП 203 (Комплект_1)"
**Результат:** 
- keywords_ratio = 100% (все ключевые слова найдены)
- score = 100.0
- match_percentage = 100%

### Пример 2: Частичное совпадение (70% ключевых слов)
**Товар:** "ДенсТоп ЭП 203" → ключевые слова: ["денстоп", "эп", "203"]
**Текст в документе:** "ДенсТоп ЭП" (нет "203")
**Результат:**
- keywords_ratio = 66.7% (2 из 3 ключевых слов)
- score = 85.0 + (0.667 - 0.6) * 15.0 = 86.0
- match_percentage = 85% (так как score >= 85)

### Пример 3: Дополнительная фраза
**Текст в документе:** "композитное перильное ограждение"
**Результат:**
- Фраза найдена в списке дополнительных фраз
- score = 85.0 (фиксированный)
- match_percentage = 85%

### Пример 4: Недостаточно ключевых слов (25%)
**Товар:** "ДенсТоп ЭП 203" → ключевые слова: ["денстоп", "эп", "203"]
**Текст в документе:** "ДенсТоп" (только 1 из 3 ключевых слов)
**Результат:**
- keywords_ratio = 33.3% (1 из 3 ключевых слов)
- Но это < 60%, поэтому:
  - keywords_ratio = 33.3% < 30%? Нет, 33.3% >= 30%
  - score = 35.0 + (0.333 - 0.3) * 50.0 = 36.65
- score = 36.65 < 85 → отфильтровывается
- match_percentage = 0% (нет совпадений с score >= 85)

