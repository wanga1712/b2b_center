# Условия для установки статусов закупок

## Порядок проверки (ВАЖНО!)

Статусы проверяются в следующем порядке (от более специфичных к общим):

1. **Разыграна** (status_id = 3)
2. **Плохие** (status_id = 4)
3. **Работа комиссии** (status_id = 2)
4. **Новая** (status_id = 1)

## Условия для 44ФЗ

### 1. СТАТУС "РАЗЫГРАНА" (status_id = 3)
**Проверяется ПЕРВЫМ**

```sql
delivery_end_date IS NOT NULL 
AND delivery_end_date >= CURRENT_DATE + INTERVAL '90 days'
```

**Описание:** Закупки, у которых определена дата окончания поставки (`delivery_end_date`) и она не ранее чем через 90 дней от текущей даты.

**Пример:** 
- Текущая дата: 2025-12-05
- `delivery_end_date` = 2026-03-05 (через 90 дней)
- Статус: "Разыграна"

---

### 2. СТАТУС "ПЛОХИЕ" (status_id = 4)
**Проверяется ВТОРЫМ**

```sql
delivery_end_date IS NULL
```

**Описание:** Закупки, у которых не определена дата окончания поставки.

**Пример:**
- `delivery_end_date` = NULL
- Статус: "Плохие"

---

### 3. СТАТУС "РАБОТА КОМИССИИ" (status_id = 2)
**Проверяется ТРЕТЬИМ**

```sql
end_date IS NOT NULL
AND end_date > CURRENT_DATE
AND end_date <= CURRENT_DATE + INTERVAL '90 days'
AND (delivery_end_date IS NULL OR delivery_end_date < CURRENT_DATE + INTERVAL '90 days')
```

**Описание:** Закупки, которые завершатся в ближайшие 90 дней, но НЕ имеют `delivery_end_date >= CURRENT_DATE + 90 дней` (такие уже обработаны как "Разыграна").

**Пример:**
- Текущая дата: 2025-12-05
- `end_date` = 2025-12-20 (через 15 дней)
- `delivery_end_date` = NULL или < 2026-03-05
- Статус: "Работа комиссии"

---

### 4. СТАТУС "НОВАЯ" (status_id = 1)
**Проверяется ПОСЛЕДНИМ**

```sql
end_date IS NOT NULL
AND end_date <= CURRENT_DATE
AND (delivery_end_date IS NULL OR delivery_end_date < CURRENT_DATE + INTERVAL '90 days')
```

**Описание:** Закупки, которые уже завершились (до текущей даты), но НЕ имеют `delivery_end_date >= CURRENT_DATE + 90 дней` (такие уже обработаны как "Разыграна").

**Пример:**
- Текущая дата: 2025-12-05
- `end_date` = 2025-12-01 (4 дня назад)
- `delivery_end_date` = NULL или < 2026-03-05
- Статус: "Новая"

---

## Условия для 223ФЗ

### СТАТУС "ПЛОХИЕ" (status_id = 4)

```sql
end_date IS NOT NULL
AND end_date > CURRENT_DATE + INTERVAL '180 days'
```

**Описание:** Закупки 223ФЗ, у которых дата окончания более чем через 180 дней от текущей даты.

**Важно:** Все остальные записи 223ФЗ остаются без статуса (status_id IS NULL) и используются в поиске.

---

## Взаимоисключающие условия

Условия сделаны взаимоисключающими:

1. **"Разыграна"** имеет приоритет над "Новая" и "Работа комиссии"
   - Если `delivery_end_date >= CURRENT_DATE + 90 дней`, запись получает статус "Разыграна", даже если `end_date <= CURRENT_DATE`

2. **"Плохие"** имеет приоритет только для записей без `delivery_end_date`

3. **"Работа комиссии"** и **"Новая"** исключают записи с `delivery_end_date >= CURRENT_DATE + 90 дней`

---

## Примеры пересечений

### Пример 1: Запись попадает в "Разыграна" И "Новая"
- `end_date` = 2025-11-17 (завершилась до текущей даты)
- `delivery_end_date` = 2026-03-05 (>= CURRENT_DATE + 90 дней)
- **Результат:** Статус "Разыграна" (проверяется первым)

### Пример 2: Запись попадает в "Работа комиссии" И "Разыграна"
- `end_date` = 2025-12-20 (в ближайшие 90 дней)
- `delivery_end_date` = 2026-03-05 (>= CURRENT_DATE + 90 дней)
- **Результат:** Статус "Разыграна" (проверяется первым)

---

## Важные замечания

1. **Порядок проверки критичен** - статусы проверяются от более специфичных к общим
2. **Записи с status_id = 4 ("Плохие") не обновляются** - они исключены из автоматического обновления
3. **Для 223ФЗ** большинство записей остаются без статуса (status_id IS NULL) и используются в поиске
4. **Условия должны быть взаимоисключающими** - каждая запись должна получить только один статус

