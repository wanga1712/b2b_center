# Правила обновления статусов закупок

## Порядок проверки статусов (КРИТИЧЕСКИ ВАЖНО!)

Статусы проверяются **строго в следующем порядке** (от более специфичных к общим):

1. **Разыграна** (status_id = 3) - ПЕРВЫМ
2. **Плохие** (status_id = 4) - ВТОРЫМ  
3. **Работа комиссии** (status_id = 2) - ТРЕТЬИМ
4. **Новая** (status_id = 1) - ПОСЛЕДНИМ

---

## Условия для 44ФЗ

### 1. СТАТУС "РАЗЫГРАНА" (status_id = 3)
**Проверяется ПЕРВЫМ - имеет наивысший приоритет**

**Условие установки:**
```sql
delivery_end_date IS NOT NULL 
AND delivery_end_date >= CURRENT_DATE + INTERVAL '90 days'
AND (status_id IS NULL OR status_id != 3)  -- Обновляем только если статус другой
AND status_id != 4  -- НЕ трогаем "Плохие"
```

**Когда обновляется:**
- ✅ Новые записи без статуса (status_id IS NULL)
- ✅ Записи с другими статусами (1, 2), которые соответствуют условию
- ❌ Записи со статусом "Плохие" (status_id = 4) - НЕ обновляются
- ❌ Записи, которые уже имеют статус "Разыграна" (status_id = 3) - НЕ обновляются

**Пример:**
- Текущая дата: 2025-12-05
- `delivery_end_date` = 2026-03-05 (через 90 дней)
- Статус: "Разыграна" (даже если `end_date` <= CURRENT_DATE)

---

### 2. СТАТУС "ПЛОХИЕ" (status_id = 4)
**Проверяется ВТОРЫМ - защищен от перезаписи**

**Условие установки:**
```sql
delivery_end_date IS NULL
AND status_id IS NULL  -- ТОЛЬКО для новых записей без статуса
```

**Когда обновляется:**
- ✅ ТОЛЬКО новые записи без статуса (status_id IS NULL)
- ❌ Записи, которые уже имеют ЛЮБОЙ статус - НЕ обновляются
- ❌ Записи со статусом "Плохие" - НЕ обновляются (защищены)

**ВАЖНО:** После установки статуса "Плохие" он **НИКОГДА не перезаписывается** другими статусами!

**Пример:**
- `delivery_end_date` = NULL
- `status_id` = NULL
- Результат: Статус "Плохие"

---

### 3. СТАТУС "РАБОТА КОМИССИИ" (status_id = 2)
**Проверяется ТРЕТЬИМ**

**Условие установки:**
```sql
end_date IS NOT NULL
AND end_date > CURRENT_DATE
AND end_date <= CURRENT_DATE + INTERVAL '90 days'
AND (delivery_end_date IS NULL OR delivery_end_date < CURRENT_DATE + INTERVAL '90 days')
AND (status_id IS NULL OR status_id != 2)  -- Обновляем только если статус другой
AND (status_id IS NULL OR status_id != 4)  -- НЕ трогаем "Плохие"
```

**Когда обновляется:**
- ✅ Новые записи без статуса (status_id IS NULL)
- ✅ Записи со статусом "Новая" (status_id = 1), которые соответствуют условию
- ❌ Записи со статусом "Плохие" (status_id = 4) - НЕ обновляются
- ❌ Записи со статусом "Разыграна" (status_id = 3) - уже обработаны первым шагом
- ❌ Записи, которые уже имеют статус "Работа комиссии" (status_id = 2) - НЕ обновляются

**Пример:**
- Текущая дата: 2025-12-05
- `end_date` = 2025-12-20 (через 15 дней)
- `delivery_end_date` = NULL или < 2026-03-05
- Статус: "Работа комиссии"

---

### 4. СТАТУС "НОВАЯ" (status_id = 1)
**Проверяется ПОСЛЕДНИМ**

**Условие установки:**
```sql
end_date IS NOT NULL
AND end_date <= CURRENT_DATE
AND (delivery_end_date IS NULL OR delivery_end_date < CURRENT_DATE + INTERVAL '90 days')
AND (status_id IS NULL OR status_id != 1)  -- Обновляем только если статус другой
AND (status_id IS NULL OR status_id != 4)  -- НЕ трогаем "Плохие"
```

**Когда обновляется:**
- ✅ Новые записи без статуса (status_id IS NULL)
- ✅ Записи со статусом "Работа комиссии" (status_id = 2), у которых `end_date` уже прошел
- ❌ Записи со статусом "Плохие" (status_id = 4) - НЕ обновляются
- ❌ Записи со статусом "Разыграна" (status_id = 3) - уже обработаны первым шагом
- ❌ Записи, которые уже имеют статус "Новая" (status_id = 1) - НЕ обновляются

**Пример:**
- Текущая дата: 2025-12-05
- `end_date` = 2025-12-01 (4 дня назад)
- `delivery_end_date` = NULL или < 2026-03-05
- Статус: "Новая"

---

## Условия для 223ФЗ

### СТАТУС "ПЛОХИЕ" (status_id = 4)

**Условие установки:**
```sql
end_date IS NOT NULL
AND end_date > CURRENT_DATE + INTERVAL '180 days'
AND status_id IS NULL  -- ТОЛЬКО для новых записей без статуса
```

**Когда обновляется:**
- ✅ ТОЛЬКО новые записи без статуса (status_id IS NULL)
- ❌ Записи, которые уже имеют статус - НЕ обновляются

**ВАЖНО:** 
- Все остальные записи 223ФЗ остаются **без статуса** (status_id IS NULL)
- Записи без статуса **используются в поиске**
- Записи со статусом "Плохие" **исключаются из поиска**

---

## Защита статуса "Плохие" от перезаписи

### Как работает защита:

1. **При установке "Плохие":**
   - Устанавливается ТОЛЬКО для записей с `status_id IS NULL`
   - После установки статус защищен

2. **При обновлении других статусов:**
   - Все условия для "Разыграна", "Работа комиссии", "Новая" содержат:
     ```sql
     AND status_id != 4  -- или AND (status_id IS NULL OR status_id != 4)
     ```
   - Это гарантирует, что записи со статусом "Плохие" НЕ будут перезаписаны

3. **Результат:**
   - Статус "Плохие" устанавливается один раз
   - После установки он **НИКОГДА не изменяется** автоматически
   - Записи со статусом "Плохие" исключаются из поиска

---

## Примеры обновления статусов

### Пример 1: Новая запись
**Исходное состояние:**
- `status_id` = NULL
- `end_date` = 2025-12-01
- `delivery_end_date` = NULL

**Результат:**
- ✅ Шаг 1 ("Разыграна"): не подходит (delivery_end_date IS NULL)
- ✅ Шаг 2 ("Плохие"): **ПОДХОДИТ** → статус = 4 ("Плохие")
- ❌ Шаг 3 ("Работа комиссии"): пропущена (status_id = 4)
- ❌ Шаг 4 ("Новая"): пропущена (status_id = 4)

**Итог:** Статус "Плохие" (status_id = 4)

---

### Пример 2: Запись с delivery_end_date
**Исходное состояние:**
- `status_id` = NULL
- `end_date` = 2025-11-17
- `delivery_end_date` = 2026-03-05

**Результат:**
- ✅ Шаг 1 ("Разыграна"): **ПОДХОДИТ** → статус = 3 ("Разыграна")
- ❌ Шаг 2 ("Плохие"): пропущена (status_id = 3)
- ❌ Шаг 3 ("Работа комиссии"): пропущена (status_id = 3)
- ❌ Шаг 4 ("Новая"): пропущена (status_id = 3)

**Итог:** Статус "Разыграна" (status_id = 3)

---

### Пример 3: Изменение статуса "Работа комиссии" → "Новая"
**Исходное состояние:**
- `status_id` = 2 ("Работа комиссии")
- `end_date` = 2025-12-01 (прошла)
- `delivery_end_date` = NULL

**Результат:**
- ❌ Шаг 1 ("Разыграна"): не подходит (delivery_end_date IS NULL)
- ❌ Шаг 2 ("Плохие"): пропущена (status_id = 2, не NULL)
- ❌ Шаг 3 ("Работа комиссии"): пропущена (status_id = 2, уже установлен)
- ✅ Шаг 4 ("Новая"): **ПОДХОДИТ** → статус = 1 ("Новая")

**Итог:** Статус изменен с "Работа комиссии" на "Новая"

---

### Пример 4: Защита "Плохие" от перезаписи
**Исходное состояние:**
- `status_id` = 4 ("Плохие")
- `end_date` = 2025-12-01
- `delivery_end_date` = NULL

**Результат:**
- ❌ Шаг 1 ("Разыграна"): пропущена (status_id = 4, защищена)
- ❌ Шаг 2 ("Плохие"): пропущена (status_id = 4, уже установлен)
- ❌ Шаг 3 ("Работа комиссии"): пропущена (status_id = 4, защищена)
- ❌ Шаг 4 ("Новая"): пропущена (status_id = 4, защищена)

**Итог:** Статус остается "Плохие" (status_id = 4) - **НЕ ИЗМЕНЯЕТСЯ**

---

## Важные правила

1. **Порядок проверки критичен** - статусы проверяются строго в указанном порядке
2. **"Плохие" защищены** - после установки статус "Плохие" НИКОГДА не перезаписывается
3. **"Разыграна" имеет приоритет** - если `delivery_end_date >= CURRENT_DATE + 90 дней`, запись получает статус "Разыграна", независимо от других условий
4. **Обновление только при изменении** - записи обновляются только если текущий статус не соответствует условию
5. **Для 223ФЗ** большинство записей остаются без статуса и используются в поиске

---

## Когда запускается обновление

1. **При старте приложения** - автоматически через `TenderStatusUpdater`
2. **Периодически в фоне** - функция `update_all_tender_statuses()` вызывается автоматически
3. **Вручную** - через скрипт `recalculate_statuses.py`

---

## Исключения из обновления

Следующие записи **НЕ обновляются** автоматически:

1. ✅ Записи со статусом "Плохие" (status_id = 4) - защищены от перезаписи
2. ✅ Записи, которые уже имеют правильный статус - не обновляются без необходимости
3. ✅ Для 223ФЗ: записи без статуса остаются без статуса (используются в поиске)

