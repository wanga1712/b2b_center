# –ü—Ä–∞–≤–∏–ª–∞ –≤—ã–±–æ—Ä–∫–∏ –¥–∞–Ω–Ω—ã—Ö –æ –∑–∞–∫—É–ø–∫–∞—Ö –∏–∑ –ë–î

## üìã –¢–µ–∫—É—â–∏–µ –ø—Ä–∞–≤–∏–ª–∞ –≤—ã–±–æ—Ä–∫–∏ (–ø–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –Ω–∞ —Å—Ç–∞—Ç—É—Å—ã)

### ‚úÖ –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Å—Ç–∞—Ç—É—Å—ã (–±—ã—Å—Ç—Ä–æ, —Å –∏–Ω–¥–µ–∫—Å–∞–º–∏):

#### 1. –ù–æ–≤—ã–µ –∑–∞–∫—É–ø–∫–∏ 44–§–ó
```sql
WHERE r.status_id = 1  -- –¢–æ–ª—å–∫–æ –Ω–æ–≤—ã–µ (–Ω–µ —Ä–∞–±–æ—Ç–∞ –∫–æ–º–∏—Å—Å–∏–∏!)
  AND r.okpd_id IN (...)
  AND r.region_id = ? (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
  AND LOWER(r.auction_name) NOT LIKE '%—Å—Ç–æ–ø-—Å–ª–æ–≤–æ%'
```
**–ò–Ω–¥–µ–∫—Å:** `idx_reestr_contract_44_fz_status_id` –Ω–∞ `status_id`
**–£—Å–∫–æ—Ä–µ–Ω–∏–µ:** 10-150x –ø–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—é —Å –¥–∞—Ç–∞–º–∏

#### 2. –†–∞–±–æ—Ç–∞ –∫–æ–º–∏—Å—Å–∏–∏ 44–§–ó
```sql
WHERE r.status_id = 2  -- –†–∞–±–æ—Ç–∞ –∫–æ–º–∏—Å—Å–∏–∏
  AND r.okpd_id IN (...)
  AND r.region_id = ? (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
  AND LOWER(r.auction_name) NOT LIKE '%—Å—Ç–æ–ø-—Å–ª–æ–≤–æ%'
```
**–ò–Ω–¥–µ–∫—Å:** `idx_reestr_contract_44_fz_status_id` –Ω–∞ `status_id`
**–£—Å–∫–æ—Ä–µ–Ω–∏–µ:** 10-150x –ø–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—é —Å –¥–∞—Ç–∞–º–∏

#### 3. –†–∞–∑—ã–≥—Ä–∞–Ω–Ω—ã–µ –∑–∞–∫—É–ø–∫–∏ 44–§–ó
```sql
WHERE r.status_id = 3  -- –†–∞–∑—ã–≥—Ä–∞–Ω–∞
  AND r.okpd_id IN (...)
  AND r.region_id = ? (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
  AND LOWER(r.auction_name) NOT LIKE '%—Å—Ç–æ–ø-—Å–ª–æ–≤–æ%'
```
**–ò–Ω–¥–µ–∫—Å:** `idx_reestr_contract_44_fz_status_delivery_end_date` –Ω–∞ `(status_id, delivery_end_date)`
**–£—Å–∫–æ—Ä–µ–Ω–∏–µ:** 20-300x –ø–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—é —Å –¥–∞—Ç–∞–º–∏

#### 4. –ù–æ–≤—ã–µ –∑–∞–∫—É–ø–∫–∏ 223–§–ó
```sql
WHERE (r.status_id IS NULL OR r.status_id != 4)  -- –ò—Å–∫–ª—é—á–∞–µ–º "–ü–ª–æ—Ö–∏–µ"
  AND r.okpd_id IN (...)
  AND r.region_id = ? (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
  AND LOWER(r.auction_name) NOT LIKE '%—Å—Ç–æ–ø-—Å–ª–æ–≤–æ%'
```
**–ò–Ω–¥–µ–∫—Å:** `idx_reestr_contract_223_fz_status_id` –Ω–∞ `status_id`
**–£—Å–∫–æ—Ä–µ–Ω–∏–µ:** 10-150x –ø–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—é —Å –¥–∞—Ç–∞–º–∏

### ‚ö†Ô∏è –í—Å–µ –µ—â–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –¥–∞—Ç—ã (–º–µ–¥–ª–µ–Ω–Ω–æ, –±–µ–∑ –∏–Ω–¥–µ–∫—Å–æ–≤):

#### 5. –†–∞–∑—ã–≥—Ä–∞–Ω–Ω—ã–µ –∑–∞–∫—É–ø–∫–∏ 223–§–ó
```sql
WHERE r.end_date < CURRENT_DATE
  AND r.delivery_end_date IS NOT NULL 
  AND r.delivery_end_date >= CURRENT_DATE + INTERVAL '90 days'
  AND (r.status_id IS NULL OR r.status_id != 4)  -- –ò—Å–∫–ª—é—á–∞–µ–º "–ü–ª–æ—Ö–∏–µ"
  AND r.okpd_id IN (...)
  AND r.region_id = ? (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
  AND LOWER(r.auction_name) NOT LIKE '%—Å—Ç–æ–ø-—Å–ª–æ–≤–æ%'
```
**–ü—Ä–æ–±–ª–µ–º–∞:** –ù–µ—Ç —Å—Ç–∞—Ç—É—Å–∞ "–†–∞–∑—ã–≥—Ä–∞–Ω–∞" –¥–ª—è 223–§–ó, –ø–æ—ç—Ç–æ–º—É –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å—Ç–∞—Ä—ã–π —Å–ø–æ—Å–æ–±
**–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:** ~5-15 —Å–µ–∫—É–Ω–¥ (–º–µ–¥–ª–µ–Ω–Ω–æ!)
**–†–µ—à–µ–Ω–∏–µ:** –ù—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å "–†–∞–∑—ã–≥—Ä–∞–Ω–∞" –¥–ª—è 223–§–ó –∏–ª–∏ —Å–æ–∑–¥–∞—Ç—å —Å–æ—Å—Ç–∞–≤–Ω–æ–π –∏–Ω–¥–µ–∫—Å –Ω–∞ `(end_date, delivery_end_date, status_id)`

---

## üîç –ì–¥–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —ç—Ç–∏ –ø—Ä–∞–≤–∏–ª–∞:

### 1. `TenderQueryBuilder.build_new_tenders_filter()`
- **–î–ª—è –Ω–æ–≤—ã—Ö 44–§–ó:** `status_id = 1` ‚úÖ
- **–î–ª—è –Ω–æ–≤—ã—Ö 223–§–ó:** `status_id IS NULL OR status_id != 4` ‚úÖ

### 2. `TenderQueryBuilder.build_commission_tenders_filter()`
- **–î–ª—è —Ä–∞–±–æ—Ç—ã –∫–æ–º–∏—Å—Å–∏–∏ 44–§–ó:** `status_id = 2` ‚úÖ

### 3. `TenderQueryBuilder.build_won_tenders_filter()`
- **–î–ª—è —Ä–∞–∑—ã–≥—Ä–∞–Ω–Ω—ã—Ö 44–§–ó:** `status_id = 3` ‚úÖ
- **–î–ª—è —Ä–∞–∑—ã–≥—Ä–∞–Ω–Ω—ã—Ö 223–§–ó:** –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å—Ç–∞—Ä—ã–π —Å–ø–æ—Å–æ–± —Å –¥–∞—Ç–∞–º–∏ ‚ö†Ô∏è

### 4. `PurchasesCountsService.get_counts()`
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –ø—Ä—è–º—ã–µ SQL –∑–∞–ø—Ä–æ—Å—ã —Å `status_id` ‚úÖ
- –í—Å–µ –∑–∞–ø—Ä–æ—Å—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç —Å—Ç–∞—Ç—É—Å—ã, –∫—Ä–æ–º–µ —Ä–∞–∑—ã–≥—Ä–∞–Ω–Ω—ã—Ö 223–§–ó ‚ö†Ô∏è

---

## üöÄ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —É—Å–∫–æ—Ä–µ–Ω–∏—é:

### 1. –î–ª—è —Ä–∞–∑—ã–≥—Ä–∞–Ω–Ω—ã—Ö 223–§–ó:
**–í–∞—Ä–∏–∞–Ω—Ç –ê:** –î–æ–±–∞–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å "–†–∞–∑—ã–≥—Ä–∞–Ω–∞" (status_id = 3) –¥–ª—è 223–§–ó
**–í–∞—Ä–∏–∞–Ω—Ç –ë:** –°–æ–∑–¥–∞—Ç—å —Å–æ—Å—Ç–∞–≤–Ω–æ–π –∏–Ω–¥–µ–∫—Å:
```sql
CREATE INDEX idx_223fz_won_composite 
ON reestr_contract_223_fz(end_date, delivery_end_date, status_id, okpd_id)
WHERE end_date < CURRENT_DATE 
  AND delivery_end_date >= CURRENT_DATE + INTERVAL '90 days'
  AND (status_id IS NULL OR status_id != 4);
```

### 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞–ª–∏—á–∏–µ –∏–Ω–¥–µ–∫—Å–æ–≤:
```sql
-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏–Ω–¥–µ–∫—Å—ã –Ω–∞ status_id
SELECT indexname, indexdef 
FROM pg_indexes 
WHERE tablename IN ('reestr_contract_44_fz', 'reestr_contract_223_fz')
  AND indexdef LIKE '%status_id%';
```

### 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–æ–≤:
```sql
-- –í–∫–ª—é—á–∏—Ç—å EXPLAIN –¥–ª—è –∑–∞–ø—Ä–æ—Å–æ–≤
EXPLAIN ANALYZE
SELECT COUNT(*) FROM reestr_contract_44_fz
WHERE status_id = 1 AND okpd_id IN (...);
```

---

## üìä –°—Ç–∞—Ç—É—Å—ã –∑–∞–∫—É–ø–æ–∫:

| status_id | –ù–∞–∑–≤–∞–Ω–∏–µ | –û–ø–∏—Å–∞–Ω–∏–µ | –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è |
|-----------|----------|----------|------------------|
| 1 | –ù–æ–≤–∞—è | `end_date <= CURRENT_DATE` | –ù–æ–≤—ã–µ –∑–∞–∫—É–ø–∫–∏ 44–§–ó |
| 2 | –†–∞–±–æ—Ç–∞ –∫–æ–º–∏—Å—Å–∏–∏ | `end_date > CURRENT_DATE AND end_date <= CURRENT_DATE + 90 –¥–Ω–µ–π` | –†–∞–±–æ—Ç–∞ –∫–æ–º–∏—Å—Å–∏–∏ 44–§–ó |
| 3 | –†–∞–∑—ã–≥—Ä–∞–Ω–∞ | `delivery_end_date >= CURRENT_DATE + 90 –¥–Ω–µ–π` | –†–∞–∑—ã–≥—Ä–∞–Ω–Ω—ã–µ –∑–∞–∫—É–ø–∫–∏ 44–§–ó |
| 4 | –ü–ª–æ—Ö–∞—è | –ò—Å–∫–ª—é—á–∞–µ—Ç—Å—è –∏–∑ –≤—ã–±–æ—Ä–∫–∏ | - |
| NULL | (–Ω–µ—Ç —Å—Ç–∞—Ç—É—Å–∞) | –î–ª—è 223–§–ó - —Å—á–∏—Ç–∞–µ—Ç—Å—è "—Ö–æ—Ä–æ—à–µ–π" | –ù–æ–≤—ã–µ –∑–∞–∫—É–ø–∫–∏ 223–§–ó |

---

## ‚ö° –¢–µ–∫—É—â–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:

| –†–∞–∑–¥–µ–ª | –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —Å—Ç–∞—Ç—É—Å—ã? | –ò–Ω–¥–µ–∫—Å? | –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è |
|--------|---------------------|---------|------------------|
| –ù–æ–≤—ã–µ 44–§–ó | ‚úÖ –î–∞ (`status_id = 1`) | ‚úÖ –î–∞ | ~0.1-0.5 —Å–µ–∫ |
| –†–∞–±–æ—Ç–∞ –∫–æ–º–∏—Å—Å–∏–∏ 44–§–ó | ‚úÖ –î–∞ (`status_id = 2`) | ‚úÖ –î–∞ | ~0.1-0.5 —Å–µ–∫ |
| –†–∞–∑—ã–≥—Ä–∞–Ω–Ω—ã–µ 44–§–ó | ‚úÖ –î–∞ (`status_id = 3`) | ‚úÖ –î–∞ | ~0.1-0.5 —Å–µ–∫ |
| –ù–æ–≤—ã–µ 223–§–ó | ‚úÖ –î–∞ (`status_id IS NULL OR != 4`) | ‚úÖ –î–∞ | ~0.1-0.5 —Å–µ–∫ |
| –†–∞–∑—ã–≥—Ä–∞–Ω–Ω—ã–µ 223–§–ó | ‚ùå –ù–µ—Ç (–¥–∞—Ç—ã) | ‚ùå –ù–µ—Ç | ~5-15 —Å–µ–∫ ‚ö†Ô∏è |

