# –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º –ø—Ä–∏ –º–∏–≥—Ä–∞—Ü–∏–∏ —Å—Ç–∞—Ç—É—Å–æ–≤

## ‚ö†Ô∏è –°–∫—Ä–∏–ø—Ç "–∑–∞–≤–∏—Å" - —á—Ç–æ –¥–µ–ª–∞—Ç—å?

### –≠—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ!

–ü—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ **22 –º–ª–Ω –∑–∞–ø–∏—Å–µ–π** –º–∏–≥—Ä–∞—Ü–∏—è –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å **10-30 –º–∏–Ω—É—Ç**. –≠—Ç–æ **–Ω–æ—Ä–º–∞–ª—å–Ω–æ**!

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**
- ‚úÖ PostgreSQL –æ–±–Ω–æ–≤–ª—è–µ—Ç –º–∏–ª–ª–∏–æ–Ω—ã –∑–∞–ø–∏—Å–µ–π
- ‚úÖ –ü–∏—à–µ—Ç –≤ WAL (Write-Ahead Log) –Ω–∞ –¥–∏—Å–∫
- ‚úÖ –û–±–Ω–æ–≤–ª—è–µ—Ç –∏–Ω–¥–µ–∫—Å—ã
- ‚úÖ –ú–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

**–ü–æ—á–µ–º—É Ctrl+C –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å—Ä–∞–∑—É:**
- PostgreSQL –±–ª–æ–∫–∏—Ä—É–µ—Ç —Ç–∞–±–ª–∏—Ü—É –≤–æ –≤—Ä–µ–º—è UPDATE
- –ü—Ä–æ—Ü–µ—Å—Å –º–æ–∂–µ—Ç –±—ã—Ç—å –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ –æ–∂–∏–¥–∞–Ω–∏—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
- –ù—É–∂–Ω–æ –¥–æ–∂–¥–∞—Ç—å—Å—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–π –æ–ø–µ—Ä–∞—Ü–∏–∏

---

## üîç –ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –º–∏–≥—Ä–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç?

### –í–∞—Ä–∏–∞–Ω—Ç 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

–û—Ç–∫—Ä–æ–π—Ç–µ **–Ω–æ–≤—ã–π —Ç–µ—Ä–º–∏–Ω–∞–ª** (–Ω–µ –∑–∞–∫—Ä—ã–≤–∞–π—Ç–µ —Ç–µ–∫—É—â–∏–π!) –∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ:

```bash
# –û–¥–Ω–æ–∫—Ä–∞—Ç–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
python scripts/check_migration_progress.py

# –ò–ª–∏ —Ä–µ–∂–∏–º –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ (–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥)
python scripts/check_migration_progress.py --watch
```

–°–∫—Ä–∏–ø—Ç –ø–æ–∫–∞–∂–µ—Ç:
- –°–∫–æ–ª—å–∫–æ –∑–∞–ø–∏—Å–µ–π —É–∂–µ –æ–±–Ω–æ–≤–ª–µ–Ω–æ
- –°–∫–æ–ª—å–∫–æ –æ—Å—Ç–∞–ª–æ—Å—å
- –ê–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –≤ –ë–î

### –í–∞—Ä–∏–∞–Ω—Ç 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ psql

–û—Ç–∫—Ä–æ–π—Ç–µ **–Ω–æ–≤—ã–π —Ç–µ—Ä–º–∏–Ω–∞–ª** –∏ –ø–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å –∫ –ë–î:

```bash
psql -h localhost -U postgres -d tender_monitor
```

–ó–∞—Ç–µ–º –≤—ã–ø–æ–ª–Ω–∏—Ç–µ:

```sql
-- –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
SELECT 
    COUNT(*) as total,
    COUNT(CASE WHEN status_id IS NOT NULL THEN 1 END) as with_status,
    COUNT(CASE WHEN status_id IS NULL THEN 1 END) as without_status
FROM reestr_contract_44_fz;

-- –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
SELECT pid, state, query_start, now() - query_start as duration
FROM pg_stat_activity
WHERE state != 'idle';
```

### –í–∞—Ä–∏–∞–Ω—Ç 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ pgAdmin –∏–ª–∏ –¥—Ä—É–≥–æ–π –∫–ª–∏–µ–Ω—Ç

–ü–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å –∫ –ë–î –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ SQL –∑–∞–ø—Ä–æ—Å—ã –∏–∑ `scripts/check_migration_progress.sql`

---

## ‚è±Ô∏è –û—Ü–µ–Ω–∫–∞ –≤—Ä–µ–º–µ–Ω–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

| –û–ø–µ—Ä–∞—Ü–∏—è | –û—Ü–µ–Ω–∫–∞ –≤—Ä–µ–º–µ–Ω–∏ |
|----------|----------------|
| –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü –∏ —Å—Ç–æ–ª–±—Ü–æ–≤ | 1-2 —Å–µ–∫—É–Ω–¥—ã |
| –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–æ–≤ 44–§–ó (22 –º–ª–Ω –∑–∞–ø–∏—Å–µ–π) | 5-15 –º–∏–Ω—É—Ç |
| –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–æ–≤ 223–§–ó | 1-5 –º–∏–Ω—É—Ç |
| –°–æ–∑–¥–∞–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–æ–≤ | 2-5 –º–∏–Ω—É—Ç |
| **–ò–¢–û–ì–û** | **10-30 –º–∏–Ω—É—Ç** |

**–§–∞–∫—Ç–æ—Ä—ã, –≤–ª–∏—è—é—â–∏–µ –Ω–∞ —Å–∫–æ—Ä–æ—Å—Ç—å:**
- –°–∫–æ—Ä–æ—Å—Ç—å –¥–∏—Å–∫–∞ (SSD –±—ã—Å—Ç—Ä–µ–µ HDD)
- –ù–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ –ë–î (–¥—Ä—É–≥–∏–µ –∑–∞–ø—Ä–æ—Å—ã –∑–∞–º–µ–¥–ª—è—é—Ç)
- –†–∞–∑–º–µ—Ä —Ç–∞–±–ª–∏—Ü (–±–æ–ª—å—à–µ –∑–∞–ø–∏—Å–µ–π = –¥–æ–ª—å—à–µ)
- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ PostgreSQL (work_mem, maintenance_work_mem)

---

## üõë –ß—Ç–æ –¥–µ–ª–∞—Ç—å, –µ—Å–ª–∏ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –∑–∞–≤–∏—Å–ª–æ?

### –ü—Ä–∏–∑–Ω–∞–∫–∏ –∑–∞–≤–∏—Å–∞–Ω–∏—è:
- ‚ùå –ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –¥–∏—Å–∫–∞ –±–æ–ª–µ–µ 5 –º–∏–Ω—É—Ç
- ‚ùå –ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ `pg_stat_activity`
- ‚ùå –ü—Ä–æ—Ü–µ—Å—Å Python –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç CPU
- ‚ùå –ü—Ä–æ—à–ª–æ –±–æ–ª–µ–µ 1 —á–∞—Å–∞ –±–µ–∑ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞

### –†–µ—à–µ–Ω–∏–µ 1: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏

```sql
-- –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫
SELECT 
    locktype,
    relation::regclass,
    mode,
    granted,
    pid
FROM pg_locks
WHERE relation::regclass::text IN ('reestr_contract_44_fz', 'reestr_contract_223_fz');
```

### –†–µ—à–µ–Ω–∏–µ 2: –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ (–û–°–¢–û–†–û–ñ–ù–û!)

**–¢–æ–ª—å–∫–æ –µ—Å–ª–∏ –º–∏–≥—Ä–∞—Ü–∏—è –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –∑–∞–≤–∏—Å–ª–∞!**

```sql
-- –ù–∞–π—Ç–∏ PID –ø—Ä–æ—Ü–µ—Å—Å–∞ –º–∏–≥—Ä–∞—Ü–∏–∏
SELECT pid, query, state 
FROM pg_stat_activity 
WHERE query LIKE '%UPDATE reestr_contract%';

-- –ó–∞–≤–µ—Ä—à–∏—Ç—å –ø—Ä–æ—Ü–µ—Å—Å (–∑–∞–º–µ–Ω–∏—Ç–µ PID –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–π)
SELECT pg_terminate_backend(PID);
```

**‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï:** –≠—Ç–æ –æ—Ç–∫–∞—Ç–∏—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é (ROLLBACK). –ü—Ä–∏–¥–µ—Ç—Å—è –∑–∞–ø—É—Å–∫–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –∑–∞–Ω–æ–≤–æ.

### –†–µ—à–µ–Ω–∏–µ 3: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤–µ—Ä—Å–∏—é —Å –±–∞—Ç—á–∞–º–∏

–ï—Å–ª–∏ –º–∏–≥—Ä–∞—Ü–∏—è –∑–∞–≤–∏—Å–ª–∞, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≤–µ—Ä—Å–∏—é —Å –±–∞—Ç—á–∞–º–∏:

```bash
# –û—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ —Ç–µ–∫—É—â–∏–π –ø—Ä–æ—Ü–µ—Å—Å (–µ—Å–ª–∏ –≤–æ–∑–º–æ–∂–Ω–æ)
# –ó–∞—Ç–µ–º –∑–∞–ø—É—Å—Ç–∏—Ç–µ –≤–µ—Ä—Å–∏—é —Å –±–∞—Ç—á–∞–º–∏
python scripts/apply_tender_statuses_migration_batched.py
```

–≠—Ç–∞ –≤–µ—Ä—Å–∏—è:
- ‚úÖ –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
- ‚úÖ –û–±–Ω–æ–≤–ª—è–µ—Ç –ø–æ 50k –∑–∞–ø–∏—Å–µ–π –∑–∞ —Ä–∞–∑
- ‚úÖ –ö–æ–º–º–∏—Ç–∏—Ç –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ –±–∞—Ç—á–∞ (–±–µ–∑–æ–ø–∞—Å–Ω–µ–µ)
- ‚úÖ –ú–æ–∂–Ω–æ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –º–µ–∂–¥—É –±–∞—Ç—á–∞–º–∏

---

## ‚úÖ –ü—Ä–∏–∑–Ω–∞–∫–∏ —É—Å–ø–µ—à–Ω–æ–≥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

–ú–∏–≥—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ, –µ—Å–ª–∏:
- ‚úÖ –í –ª–æ–≥–∞—Ö –ø–æ—è–≤–∏–ª–æ—Å—å "‚úÖ –ú–∏–≥—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–æ –ø—Ä–∏–º–µ–Ω–µ–Ω–∞!"
- ‚úÖ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è
- ‚úÖ –í—Å–µ –∑–∞–ø–∏—Å–∏ –∏–º–µ—é—Ç —Å—Ç–∞—Ç—É—Å—ã (–∏–ª–∏ –æ—Å—Ç–∞–ª–∏—Å—å NULL –¥–ª—è 223–§–ó)
- ‚úÖ –ò–Ω–¥–µ–∫—Å—ã —Å–æ–∑–¥–∞–Ω—ã

---

## üìä –ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏–∏

–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É:

```sql
-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º 44–§–ó
SELECT 
    ts.name as status_name,
    COUNT(*) as count
FROM reestr_contract_44_fz r
LEFT JOIN tender_statuses ts ON r.status_id = ts.id
GROUP BY ts.name, ts.id
ORDER BY ts.id;

-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º 223–§–ó
SELECT 
    CASE 
        WHEN status_id IS NULL THEN '–ë–µ–∑ —Å—Ç–∞—Ç—É—Å–∞ (–∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –≤ –ø–æ–∏—Å–∫–µ)'
        ELSE ts.name 
    END as status_name,
    COUNT(*) as count
FROM reestr_contract_223_fz r
LEFT JOIN tender_statuses ts ON r.status_id = ts.id
GROUP BY status_id, ts.name
ORDER BY status_id NULLS FIRST;
```

---

## üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

1. **–ù–µ –ø—Ä–µ—Ä—ã–≤–∞–π—Ç–µ –º–∏–≥—Ä–∞—Ü–∏—é** - –¥–∞–π—Ç–µ –µ–π –∑–∞–≤–µ—Ä—à–∏—Ç—å—Å—è (10-30 –º–∏–Ω—É—Ç)
2. **–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥** - –∑–∞–ø—É—Å—Ç–∏—Ç–µ `check_migration_progress.py --watch` –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º —Ç–µ—Ä–º–∏–Ω–∞–ª–µ
3. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–∏—Å–∫–æ–≤–æ–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ** - –º–∏–≥—Ä–∞—Ü–∏—è –º–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
4. **–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –Ω–µ—Ç –¥—Ä—É–≥–∏—Ö —Ç—è–∂–µ–ª—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤** - –æ–Ω–∏ –∑–∞–º–µ–¥–ª—è—é—Ç –º–∏–≥—Ä–∞—Ü–∏—é

---

## üö® –ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫

–ï—Å–ª–∏ –º–∏–≥—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–∏–ª–∞—Å—å —Å –æ—à–∏–±–∫–æ–π:
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: `logs/migration.log`
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –±—ã–ª–æ –æ–±–Ω–æ–≤–ª–µ–Ω–æ (–∑–∞–ø—É—Å—Ç–∏—Ç–µ `check_migration_progress.py`)
3. –ï—Å–ª–∏ –Ω—É–∂–Ω–æ - –∑–∞–ø—É—Å—Ç–∏—Ç–µ –º–∏–≥—Ä–∞—Ü–∏—é –∑–∞–Ω–æ–≤–æ (–æ–Ω–∞ –±–µ–∑–æ–ø–∞—Å–Ω–∞ - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `IF NOT EXISTS` –∏ `ON CONFLICT`)

