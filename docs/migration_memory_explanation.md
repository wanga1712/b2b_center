# –û–±—ä—è—Å–Ω–µ–Ω–∏–µ: –ü–∞–º—è—Ç—å –∏ –º–∏–≥—Ä–∞—Ü–∏—è —Å—Ç–∞—Ç—É—Å–æ–≤

## ‚ùì –ë–µ—Å–ø–æ–∫–æ–π—Å—Ç–≤–æ: "–ú—ã —á—Ç–æ –≤—Å–µ –≤ –ø–∞–º—è—Ç—å –∑–∞—Å–∞–∂–∏–≤–∞–µ–º?"

### ‚úÖ –ù–ï–¢! –î–∞–Ω–Ω—ã–µ –ù–ï –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –≤ –ø–∞–º—è—Ç—å –ø–æ–ª–Ω–æ—Å—Ç—å—é

PostgreSQL —Ä–∞–±–æ—Ç–∞–µ—Ç **—É–º–Ω–æ** –∏ **—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ**:

---

## üß† –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç UPDATE –≤ PostgreSQL

### 1. **–ù–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –≤ –ø–∞–º—è—Ç—å**

PostgreSQL **–ù–ï** –∑–∞–≥—Ä—É–∂–∞–µ—Ç –≤—Å–µ 22 –º–ª–Ω –∑–∞–ø–∏—Å–µ–π –≤ –ø–∞–º—è—Ç—å. –í–º–µ—Å—Ç–æ —ç—Ç–æ–≥–æ:

- ‚úÖ –ß–∏—Ç–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ **–ø–æ—Ä—Ü–∏—è–º–∏** (—Å—Ç—Ä–∞–Ω–∏—Ü–∞–º–∏ –ø–æ 8KB)
- ‚úÖ –û–±–Ω–æ–≤–ª—è–µ—Ç **–ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ** (–Ω–µ –≤—Å–µ —Å—Ä–∞–∑—É)
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç **–¥–∏—Å–∫–æ–≤—ã–π –∫—ç—à** –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã
- ‚úÖ –ü–∏—à–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ **WAL** (Write-Ahead Log) –Ω–∞ –¥–∏—Å–∫

### 2. **–ò—Å–ø–æ–ª—å–∑—É–µ—Ç –¥–∏—Å–∫–æ–≤—ã–π –∫—ç—à –û–°**

```
RAM (–ø–∞–º—è—Ç—å) ‚Üí –î–∏—Å–∫–æ–≤—ã–π –∫—ç—à –û–° ‚Üí –§–∏–∑–∏—á–µ—Å–∫–∏–π –¥–∏—Å–∫
```

- PostgreSQL —á–∏—Ç–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ —Å –¥–∏—Å–∫–∞
- –û–° –∫—ç—à–∏—Ä—É–µ—Ç —á–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –≤ RAM
- –≠—Ç–æ **–Ω–æ—Ä–º–∞–ª—å–Ω–æ** –∏ **—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ**
- –û–° –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–ø—Ä–∞–≤–ª—è–µ—Ç –∫—ç—à–µ–º

### 3. **WAL (Write-Ahead Log)**

–í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–Ω–∞—á–∞–ª–∞ –ø–∏—à—É—Ç—Å—è –≤ WAL –Ω–∞ –¥–∏—Å–∫:
- ‚úÖ –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ –ü–æ–∑–≤–æ–ª—è–µ—Ç –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ—Å–ª–µ —Å–±–æ—è
- ‚úÖ –≠—Ç–æ **–Ω–æ—Ä–º–∞–ª—å–Ω–æ** - –ø–æ—Å—Ç–æ—è–Ω–Ω–∞—è –∑–∞–ø–∏—Å—å –Ω–∞ –¥–∏—Å–∫

---

## üíæ –°–∫–æ–ª—å–∫–æ –ø–∞–º—è—Ç–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è?

### –†–µ–∞–ª—å–Ω–∞—è –ø–∞–º—è—Ç—å –ø—Ä–æ—Ü–µ—Å—Å–∞ PostgreSQL:

- **–û–±—ã—á–Ω–æ:** 100-500 MB –¥–ª—è UPDATE –∑–∞–ø—Ä–æ—Å–∞
- **–ú–∞–∫—Å–∏–º—É–º:** 1-2 GB (–µ—Å–ª–∏ –º–Ω–æ–≥–æ –∏–Ω–¥–µ–∫—Å–æ–≤)
- **–ù–ï 22 –º–ª–Ω –∑–∞–ø–∏—Å–µ–π –≤ –ø–∞–º—è—Ç–∏!**

### –ß—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ø–∞–º—è—Ç—å:

1. **–ë—É—Ñ–µ—Ä—ã —Å—Ç—Ä–∞–Ω–∏—Ü** (shared_buffers) - –æ–±—ã—á–Ω–æ 25% RAM
2. **–†–∞–±–æ—á–∞—è –ø–∞–º—è—Ç—å** (work_mem) - –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–æ–∫ –∏ JOIN
3. **–ö—ç—à –û–°** - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —Å–∏—Å—Ç–µ–º–æ–π

---

## ‚ö° –ü–æ—á–µ–º—É –º–∏–≥—Ä–∞—Ü–∏—è –º–µ–¥–ª–µ–Ω–Ω–∞—è?

### –ù–ï –∏–∑-–∑–∞ –ø–∞–º—è—Ç–∏, –∞ –∏–∑-–∑–∞:

1. **–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ 22 –º–ª–Ω –∑–∞–ø–∏—Å–µ–π** - —ç—Ç–æ –º–Ω–æ–≥–æ –æ–ø–µ—Ä–∞—Ü–∏–π –∑–∞–ø–∏—Å–∏
2. **–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–æ–≤** - –∫–∞–∂–¥—ã–π UPDATE –æ–±–Ω–æ–≤–ª—è–µ—Ç –≤—Å–µ –∏–Ω–¥–µ–∫—Å—ã
3. **WAL –∑–∞–ø–∏—Å–∏** - –∫–∞–∂–¥–∞—è –∑–∞–ø–∏—Å—å –ø–∏—à–µ—Ç—Å—è –≤ –ª–æ–≥
4. **–ë–ª–æ–∫–∏—Ä–æ–≤–∫–∏** - —Ç–∞–±–ª–∏—Ü–∞ –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è –¥–ª—è —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏

### –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:

- **1 –º–ª–Ω –∑–∞–ø–∏—Å–µ–π:** ~1-2 –º–∏–Ω—É—Ç—ã
- **22 –º–ª–Ω –∑–∞–ø–∏—Å–µ–π:** ~10-30 –º–∏–Ω—É—Ç
- **–≠—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ!**

---

## üîç –ü–æ—á–µ–º—É COUNT —Ç–æ–∂–µ –º–µ–¥–ª–µ–Ω–Ω—ã–π?

COUNT –Ω–∞ 22 –º–ª–Ω –∑–∞–ø–∏—Å–µ–π —Ç–æ–∂–µ –º–µ–¥–ª–µ–Ω–Ω—ã–π, –ø–æ—Ç–æ–º—É —á—Ç–æ:

- ‚ùå –î–æ–ª–∂–µ–Ω **–ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–∞–∂–¥—É—é –∑–∞–ø–∏—Å—å**
- ‚ùå –î–∞–∂–µ –µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –∏–Ω–¥–µ–∫—Å, –≤—Å–µ —Ä–∞–≤–Ω–æ –¥–æ–ª–≥–æ
- ‚ùå –î–ª—è —Ç–æ—á–Ω–æ–≥–æ COUNT –Ω—É–∂–Ω–æ –ø—Ä–æ—á–∏—Ç–∞—Ç—å –≤—Å–µ —Å—Ç—Ä–æ–∫–∏

### –†–µ—à–µ–Ω–∏–µ: –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–¥—Å—á–µ—Ç—ã

```sql
-- –ú–ï–î–õ–ï–ù–ù–û (–ø—Ä–æ–≤–µ—Ä—è–µ—Ç –≤—Å–µ 22 –º–ª–Ω –∑–∞–ø–∏—Å–µ–π)
SELECT COUNT(*) FROM reestr_contract_44_fz;

-- –ë–´–°–¢–†–û (–≤—ã–±–æ—Ä–∫–∞ 0.1%)
SELECT COUNT(*) * 1000 
FROM reestr_contract_44_fz 
TABLESAMPLE SYSTEM (0.1);
```

---

## üõ°Ô∏è –ó–∞—â–∏—Ç–∞ –æ—Ç –ø—Ä–æ–±–ª–µ–º

### PostgreSQL –∑–∞—â–∏—â–∞–µ—Ç –æ—Ç:

1. **–ü–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏—è –ø–∞–º—è—Ç–∏:**
   - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –¥–∏—Å–∫–æ–≤—ã–µ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–ø—Ä–∞–≤–ª—è–µ—Ç –ø–∞–º—è—Ç—å—é
   - –ù–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç –≤—Å–µ –¥–∞–Ω–Ω—ã–µ —Å—Ä–∞–∑—É

2. **–ü–æ—Ç–µ—Ä–∏ –¥–∞–Ω–Ω—ã—Ö:**
   - WAL –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å
   - –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ (BEGIN/COMMIT)
   - –û—Ç–∫–∞—Ç –ø—Ä–∏ –æ—à–∏–±–∫–µ (ROLLBACK)

3. **–ë–ª–æ–∫–∏—Ä–æ–≤–æ–∫:**
   - Row-level locking (–±–ª–æ–∫–∏—Ä—É–µ—Ç —Å—Ç—Ä–æ–∫–∏, –Ω–µ –≤—Å—é —Ç–∞–±–ª–∏—Ü—É)
   - –ú–æ–∂–Ω–æ —á–∏—Ç–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –≤–æ –≤—Ä–µ–º—è UPDATE

---

## ‚úÖ –ò—Ç–æ–≥

### –ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:

1. ‚úÖ PostgreSQL **–ù–ï** –∑–∞–≥—Ä—É–∂–∞–µ—Ç –≤—Å–µ 22 –º–ª–Ω –∑–∞–ø–∏—Å–µ–π –≤ –ø–∞–º—è—Ç—å
2. ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç **–ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ** (–ø–æ—Ä—Ü–∏—è–º–∏)
3. ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç **–¥–∏—Å–∫–æ–≤—ã–π –∫—ç—à** –û–° (—ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ)
4. ‚úÖ –ü–∏—à–µ—Ç –≤ **WAL** –Ω–∞ –¥–∏—Å–∫ (—ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ)
5. ‚úÖ **–ë–µ–∑–æ–ø–∞—Å–Ω–æ** - –¥–∞–Ω–Ω—ã–µ –Ω–µ –ø–æ—Ç–µ—Ä—è—é—Ç—Å—è

### –ü–æ—á–µ–º—É –º–µ–¥–ª–µ–Ω–Ω–æ:

- ‚ùå –ù–ï –∏–∑-–∑–∞ –ø–∞–º—è—Ç–∏
- ‚úÖ –ò–∑-–∑–∞ **–æ–±—ä–µ–º–∞ –¥–∞–Ω–Ω—ã—Ö** (22 –º–ª–Ω –∑–∞–ø–∏—Å–µ–π)
- ‚úÖ –ò–∑-–∑–∞ **–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏–Ω–¥–µ–∫—Å–æ–≤**
- ‚úÖ –ò–∑-–∑–∞ **WAL –∑–∞–ø–∏—Å–µ–π**

### –ß—Ç–æ –¥–µ–ª–∞—Ç—å:

1. **–ü–æ–¥–æ–∂–¥–∏—Ç–µ** - —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ –¥–ª—è —Ç–∞–∫–∏—Ö –æ–±—ä–µ–º–æ–≤
2. **–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –±—ã—Å—Ç—Ä—É—é –ø—Ä–æ–≤–µ—Ä–∫—É –ø—Ä–æ–≥—Ä–µ—Å—Å–∞:**
   ```bash
   python scripts/check_migration_progress_fast.py --watch
   ```
3. **–ò–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≤–µ—Ä—Å–∏—é —Å –±–∞—Ç—á–∞–º–∏** (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ –≤–∏–¥–µ—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å)

---

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø–∞–º—è—Ç–∏

–ï—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏:

```sql
-- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏ PostgreSQL
SELECT 
    name,
    setting,
    unit
FROM pg_settings
WHERE name IN ('shared_buffers', 'work_mem', 'maintenance_work_mem');

-- –¢–µ–∫—É—â–µ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏ –ø—Ä–æ—Ü–µ—Å—Å–∞–º–∏
SELECT 
    pid,
    usename,
    application_name,
    state,
    pg_size_pretty(pg_backend_memory_contexts()::text::bigint) as memory
FROM pg_stat_activity
WHERE state != 'idle';
```

**–û–∂–∏–¥–∞–µ–º–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:** 100-500 MB –Ω–∞ –ø—Ä–æ—Ü–µ—Å—Å –º–∏–≥—Ä–∞—Ü–∏–∏ (–ù–ï 22 –º–ª–Ω –∑–∞–ø–∏—Å–µ–π!)

