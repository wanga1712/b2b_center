# Обработка дополнительных фраз в системе поиска

## Текущее состояние

### 1. Что такое дополнительные фразы?

Дополнительные фразы - это предопределенные ключевые фразы (например, "композитное перильное ограждение", "система внешнего армирования"), которые ищутся в документах независимо от названий товаров из БД.

### 2. Где определены дополнительные фразы?

**Файл:** `services/document_search/match_finder.py`
**Метод:** `_get_additional_search_phrases()` (строки 142-291)

Список включает фразы для:
- Композитные перильные ограждения (16 вариаций)
- Система внешнего армирования (13 вариаций)
- Композитные водоотводные лотки (22 вариации)
- Инъектирование и гидроизоляция (12 вариаций)
- Наливные полы (8 вариаций)
- Промышленные полы (6 вариаций)
- Усиление конструкций (9 вариаций)

**Всего:** ~86 дополнительных фраз

### 3. Как обрабатываются дополнительные фразы?

#### Метод поиска: `search_additional_phrases()`

**Логика поиска:**
1. Перебирает все ячейки Excel файла
2. Для каждой ячейки ищет точное вхождение фразы (casefold сравнение)
3. Если фраза найдена - создает совпадение

**Ключевые особенности:**
- **Score фиксированный: 85.0** (строка 341)
- Точное совпадение фразы (не fuzzy search)
- Если фраза найдена в нескольких ячейках - сохраняется первое найденное

#### Оценка совпадения (score):

```python
# Для дополнительных фраз - фиксированный score = 85.0
found_matches[product_name] = {
    "product_name": phrase,  # Сама фраза используется как название товара
    "score": 85.0,  # ВСЕГДА 85.0
    "matched_keywords": [phrase],  # Список из одной фразы
    "is_additional_phrase": True,  # Флаг
}
```

### 4. Как рассчитывается score для основных совпадений (matched_keywords)?

**Метод:** `_check_keywords_match()` (строки 408-484)

#### Алгоритм расчета score:

1. **100% совпадение:**
   - Если найдено точное совпадение названия товара → `score = 100.0`
   - Если найдена полная фраза из ключевых слов → `score = 100.0`

2. **Частичное совпадение по ключевым словам:**

   ```
   keywords_ratio = количество_найденных_ключевых_слов / общее_количество_ключевых_слов
   ```

   **Если keywords_ratio >= 0.6 (60%+ ключевых слов найдено):**
   ```python
   score = 85.0 + (keywords_ratio - 0.6) * 15.0
   # Диапазон: 85.0 - 100.0
   ```

   **Примеры:**
   - 60% ключевых слов → score = 85.0
   - 70% ключевых слов → score = 86.5
   - 80% ключевых слов → score = 88.0
   - 90% ключевых слов → score = 91.5
   - 100% ключевых слов → score = 100.0

   **Если keywords_ratio >= 0.3 и < 0.6 (30-60% ключевых слов):**
   ```python
   score = 35.0 + (keywords_ratio - 0.3) * 50.0
   # Диапазон: 35.0 - 84.99
   ```

   **Примеры:**
   - 30% ключевых слов → score = 35.0
   - 45% ключевых слов → score = 42.5
   - 60% ключевых слов → score = 85.0

   **Если keywords_ratio < 0.3 (меньше 30% ключевых слов):**
   - Совпадение не засчитывается → `score = 0.0`

3. **Поиск с учетом опечаток:**

   Для каждого ключевого слова:
   - Сначала ищется точное вхождение
   - Если не найдено, используется fuzzy search (rapidfuzz)
   - Если similarity >= 85% → ключевое слово считается найденным

### 5. Где используются дополнительные фразы?

**Проблема:** В новой системе обработки (`match_executor.py`) дополнительные фразы **НЕ обрабатываются**!

**Старая система** (через `match_aggregator.py`):
- ✅ Вызывает `search_additional_phrases()`
- ✅ Объединяет результаты с основными совпадениями

**Новая система** (через `match_executor.py`):
- ❌ Использует только `search_workbook_for_products()`
- ❌ Дополнительные фразы не обрабатываются

### 6. Как определяется процент совпадений (match_percentage)?

**Файл:** `services/archive_runner/result_saver.py`

```python
exact_count = количество совпадений с score >= 100.0
good_count = количество совпадений с score >= 85.0

if exact_count > 0:
    match_percentage = 100.0
elif good_count > 0:
    match_percentage = 85.0
else:
    match_percentage = 0.0
```

**Важно:**
- Процент определяется по ЛУЧШЕМУ совпадению, а не по среднему
- Если есть хотя бы одно совпадение с score >= 100 → 100%
- Если нет 100%, но есть score >= 85 → 85%
- Если все совпадения < 85 → 0%

## Проблемы текущей реализации

1. **Дополнительные фразы не обрабатываются в новой системе** (`match_executor.py`)
2. **Score для дополнительных фраз всегда 85.0** (не учитывается контекст)
3. **Поиск дополнительных фраз только точный** (нет fuzzy search)
4. **Дополнительные фразы не привязываются к конкретным товарам** из БД

## Рекомендации

1. Добавить обработку дополнительных фраз в `match_executor.py`
2. Улучшить поиск дополнительных фраз (fuzzy search)
3. Связать дополнительные фразы с конкретными товарами из БД
4. Добавить логирование для отладки обработки дополнительных фраз

